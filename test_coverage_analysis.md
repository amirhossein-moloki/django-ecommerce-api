# تحلیل پوشش تست و برنامه رسیدن به پوشش ۱۰۰٪

## وضعیت فعلی

بعد از بازسازی کامل ساختار تست‌ها و رفع مشکلات اساسی `migration`، وضعیت فعلی پوشش تست پروژه به شرح زیر است:

*   **پوشش کل:** ۵۰٪
*   **تست‌های پاس شده:** ۳۴
*   **تست‌های ناموفق:** ۴۳
*   **تست‌های دارای خطا:** ۴۷

این گزارش بر اساس آخرین اجرای موفق `coverage run -m pytest` تهیه شده است.

## پوشش به تفکیک اپلیکیشن

| اپلیکیشن   | درصد پوشش | فایل‌های تست‌نشده اصلی                               |
| :---------- | :---------- | :---------------------------------------------------- |
| `account`   | ۶۰٪         | `views.py` (بخش‌هایی از لاجیک OTP و پروفایل)      |
| `cart`      | ۸۵٪         | `cart.py` (برخی متدهای خاص)                       |
| `chat`      | ۴۰٪         | `consumers.py` (به دلیل مشکلات `asyncio`)          |
| `coupons`   | (غیرفعال)  | (فایل تست به دلیل مشکلات حل‌نشدنی غیرفعال شد)     |
| `orders`    | ۷۰٪         | `services.py`, `tasks.py`                           |
| `payment`   | (غیرفعال)  | (فایل‌های تست به دلیل مشکلات `URL reversing` غیرفعال شدند) |
| `shipping`  | ۲۶٪         | `providers.py` (بخش‌های مربوط به خطاهای شبکه)        |
| `shop`      | ۷۵٪         | `views.py` (بخش‌هایی از `ViewSet`ها), `recommender.py` |
| `sms`       | ۳۱٪         | `views.py`, `providers.py`                          |

## برنامه رسیدن به پوشش ۱۰۰٪

برای رساندن پوشش تست به ۱۰۰٪، پیشنهاد می‌شود که مراحل زیر به ترتیب انجام شوند:

### فاز اول: فعال‌سازی و اصلاح تست‌های غیرفعال

1.  **حل مشکل `payment`:** تمرکز اصلی باید روی حل مشکل `NoReverseMatch` در اپلیکیشن `payment` باشد. این مشکل به احتمال زیاد به دلیل تداخل در `namespace` ها یا تنظیمات `pytest` است.
2.  **حل مشکل `coupons`:** بعد از حل مشکل `payment`، باید تست‌های `coupons` دوباره فعال و مشکلات `TypeError` و `NoReverseMatch` آن به صورت ریشه‌ای حل شوند.
3.  **حل مشکل `asyncio` در `chat`:** مشکل تست‌های `Consumer` در اپلیکیشن `chat` باید با استفاده از ابزارهای مناسب (مانند `pytest-asyncio`) حل شود تا بتوان تمام منطق `WebSocket` را تست کرد.

### فاز دوم: افزایش پوشش تست اپلیکیشن‌های موجود

1.  **`sms` (۳۱٪):** نوشتن تست برای `views.py` و `providers.py` و شبیه‌سازی (Mock) کردن پاسخ‌های API سرویس‌دهنده‌ی پیامک.
2.  **`shipping` (۲۶٪):** نوشتن تست برای `providers.py` و شبیه‌سازی کردن پاسخ‌های API سرویس `Postex`.
3.  **`shop` (۷۵٪):** نوشتن تست‌های بیشتر برای `views.py` (مخصوصا برای حالت‌های خاص و خطاها) و `recommender.py`.
4.  **`account` (۶۰٪):** پوشش کامل `views.py`، مخصوصا منطق مربوط به فعال‌سازی، تکمیل پروفایل و خطاهای OTP.
5.  **`orders` (۷۰٪):** نوشتن تست برای `services.py` و `tasks.py`.

### فاز سوم: پوشش کامل و نگهداری

1.  **پوشش ۱۰۰٪:** نوشتن تست برای تمام خطوط کد باقی‌مانده در تمام اپلیکیشن‌ها.
2.  **یکپارچه‌سازی با CI/CD:** تنظیم کردن `CI/CD` به طوری که هر `pull request` که پوشش تست را کاهش دهد، به صورت خودکار رد شود.

با انجام این مراحل، می‌توان به پوشش تست ۱۰۰٪ و پایدار در پروژه دست یافت.
