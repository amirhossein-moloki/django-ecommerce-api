import pytest
from django.urls import reverse
from rest_framework import status
from .factories import CouponFactory
from shop.factories import UserFactory

pytestmark = pytest.mark.django_db


class TestCouponModel:
    def test_is_valid(self):
        valid_coupon = CouponFactory.create()
        assert valid_coupon.is_valid()

    def test_is_invalid(self):
        invalid_coupon = CouponFactory.create(is_active=False)
        assert not invalid_coupon.is_valid()


class TestCouponAPI:
    def test_apply_coupon(self, api_client, user):
        api_client.force_authenticate(user=user)
        coupon = CouponFactory.create()
        url = reverse('api-v1:coupon-apply')
        data = {'code': coupon.code}
        response = api_client.post(url, data)
        assert response.status_code == status.HTTP_200_OK

    def test_apply_invalid_coupon(self, api_client, user):
        api_client.force_authenticate(user=user)
        url = reverse('api-v1:coupon-apply')
        data = {'code': 'INVALID'}
        response = api_client.post(url, data)
        assert response.status_code == status.HTTP_404_NOT_FOUND
