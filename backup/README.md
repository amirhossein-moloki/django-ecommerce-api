# ๐ฆ ุณุณุชู ุจฺฉุงูพ ู ุจุงุฒุงุจ Production

ุงู ูุณุชูุฏุ ูุนูุงุฑุ ุฑุงูโุงูุฏุงุฒ ู ูฺฏูโุฏุงุฑ ุณุณุชู ุจฺฉุงูพ ูพุฑูฺู ุฑุง ุชุดุฑุญ ูโฺฉูุฏ. ูุฏู ุงู ุณุณุชูุ ูุญุงูุธุช ุงุฒ ุฏุงุฏูโูุง ุญุงุช (ุฏุชุงุจุณ ู ูุงูโูุง) ุฏุฑ ุจุฑุงุจุฑ ุงููุงุน ูุฌุงุน ู ุชุถูู ุชุฏุงูู ฺฉุณุจโูฺฉุงุฑ ุงุณุช.

## ๐ฏ ุงูุฏุงู ฺฉูุฏ

-   **RPO (Recovery Point Objective):** ฺฉูุชุฑ ุงุฒ ต ุฏููู. (ุญุฏุงฺฉุซุฑ ุฏุงุฏูโุง ฺฉู ุงุฒ ุฏุณุช ูโุฏูู)
-   **RTO (Recovery Time Objective):** ฺฉูุชุฑ ุงุฒ ฑ ุณุงุนุช. (ุญุฏุงฺฉุซุฑ ุฒูุงู ุจุฑุง ุจุงุฒุงุจ ฺฉุงูู)

## ๐๏ธ ูุนูุงุฑ

ูุนูุงุฑ ุงู ุณุณุชู ุจุฑ ูพุงู ุฌุฏุงุณุงุฒ ฺฉุงูู ู ุงููุช ุทุฑุงุญ ุดุฏู ุงุณุช. ุจฺฉุงูพโูุง ุงุฒ ุณุฑูุฑูุง Production ุจู ฺฉ **Object Storage** ุงูู (ูุงููุฏ Google Cloud Storage) ุจูโุตูุฑุช ุฑูุฒูฺฏุงุฑโุดุฏู ุงุฑุณุงู ูโุดููุฏ. ุงูพูฺฉุดู ุจู ูฺโูุฌู ุจู ฺฉูุฏูุง ุจฺฉุงูพ ุฏุณุชุฑุณ ูุฏุงุฑุฏ.

```mermaid
graph TD
    subgraph "Production Environment"
        A[PostgreSQL Server] -->|Continuous WAL Archiving| B(WAL-G)
        C[Application Server] -->|Daily Snapshots| D(Restic)
    end

    subgraph "Secure Offsite Storage"
        B --> E{GCS Bucket}
        D --> E
    end

    style E fill:#90ee90,stroke:#333,stroke-width:2px
```

## ๐๏ธ ุงุฌุฒุงุก ู ุงุจุฒุงุฑูุง

### ฑ. ุจฺฉุงูพ ุฏุชุงุจุณ (PostgreSQL)

-   **ุงุจุฒุงุฑ:** `WAL-G`
-   **ุงุณุชุฑุงุชฺ:**
    -   **Point-in-Time-Recovery (PITR):** ุชูุงู ุชุบุฑุงุช ุฏุชุงุจุณ (`WAL`ูุง) ุจูโูุญุถ ููุดุชู ุดุฏูุ ุจูโุตูุฑุช ูุฏุงูู ุจู S3 ุงุฑุณุงู ูโุดููุฏ. ุงู ฺฉุงุฑ `RPO` ุฑุง ุจู ฺูุฏ ุฏููู ฺฉุงูุด ูโุฏูุฏ.
    -   **Full Base Backup:** ฺฉ ุจฺฉุงูพ ฺฉุงูู ุงุฒ ฺฉู ุฏุชุงุจุณ ุจูโุตูุฑุช ุฑูุฒุงูู ฺฏุฑูุชู ูโุดูุฏ ุชุง ููุทู ุดุฑูุน ุจุฑุง ุจุงุฒุงุจ ุจุงุดุฏ.
-   **ฺฉุงููฺฏ:** `backup/config/walg_config.json`
-   **ุงุณฺฉุฑูพุช:** `backup/scripts/run_db_backup.sh`

### ฒ. ุจฺฉุงูพ ูุงูโูุง (Media Assets)

-   **ุงุจุฒุงุฑ:** `Restic`
-   **ุงุณุชุฑุงุชฺ:**
    -   **Incremental & Deduplicated:** ุจฺฉุงูพโูุง ุจูโุตูุฑุช ุงูุฒุงุด ูุณุชูุฏ (ููุท ุชุบุฑุงุช ุฌุฏุฏ ุงุฑุณุงู ูโุดููุฏ) ู ุจุง ุงุณุชูุงุฏู ุงุฒ Deduplicationุ ุงุฒ ุฐุฎุฑู ุฏุงุฏูโูุง ุชฺฉุฑุงุฑ ุฌููฺฏุฑ ูโุดูุฏ ฺฉู ุญุฌู ู ูุฒูู ุฑุง ฺฉุงูุด ูโุฏูุฏ.
    -   **End-to-End Encryption:** ุชูุงู ูุงูโูุง ูุจู ุงุฒ ุฎุฑูุฌ ุงุฒ ุณุฑูุฑ ุจุง ฺฉ ุฑูุฒ ุนุจูุฑ ูู ุฑูุฒูฺฏุงุฑ ูโุดููุฏ.
-   **ฺฉุงููฺฏ:** ุงุฒ ุทุฑู ูุชุบุฑูุง ูุญุท (`.env`)
-   **ุงุณฺฉุฑูพุช:** `backup/scripts/run_files_backup.sh`

---

## ๐ ุฑุงูโุงูุฏุงุฒ ุงููู

1.  **ูุตุจ ุงุจุฒุงุฑูุง:**
    *   ูุทูุฆู ุดูุฏ `wal-g`, `restic` ู `jq` ุฑู ุณุฑูุฑูุง ูุฑุจูุทู ูุตุจ ูุณุชูุฏ.

2.  **ูพฺฉุฑุจูุฏ PostgreSQL:**
    *   ุจุฑุง ูุนุงูโุณุงุฒ PITRุ ูุงู `postgresql.conf` ุฑุง ูุฑุงุด ฺฉุฑุฏู ู ููุงุฏุฑ ุฒุฑ ุฑุง ุชูุธู ฺฉูุฏ:
        ```ini
        archive_mode = on
        archive_command = 'wal-g wal-push %p'
        archive_timeout = 60
        ```
    *   ูพุณ ุงุฒ ุชุบุฑุ ุณุฑูุณ PostgreSQL ุฑุง `reload` ฺฉูุฏ.

3.  **ุชูุธู ูุชุบุฑูุง ูุญุท:**
    *   ฺฉ ูุงู Service Account ุฏุฑ Google Cloud Console ุงุฌุงุฏ ฺฉุฑุฏู ู ฺฉูุฏ JSON ุขู ุฑุง ุฏุงูููุฏ ฺฉูุฏ.
    *   ฺฉ ูุงู ุฏุฑ ูุณุฑ `/etc/backup.env` ุงุฌุงุฏ ฺฉุฑุฏู ู ุชูุงู ูุชุบุฑูุง ูุญุท ุฑุง ุทุจู ููููู ุฏุฑ `backup/config/backup.cron` ุฏุฑ ุขู ูุฑุงุฑ ุฏูุฏ. ูุณุฑ ูุงู Service Account ุฑุง ุฏุฑ `GOOGLE_APPLICATION_CREDENTIALS` ูุดุฎุต ฺฉูุฏ.
    *   **ููู:** ุฏุณุชุฑุณ ูุฑ ุฏู ูุงู (`/etc/backup.env` ู ูุงู JSON) ุฑุง ุจู ุดุฏุช ูุญุฏูุฏ ฺฉูุฏ: `chmod 400 /path/to/service_account.json` ู `chmod 600 /etc/backup.env`.

4.  **ููุฏุงุฑุฏู ุงููู Restic:**
    *   ุจุฑุง ุงููู ุจุงุฑุ ุงุณฺฉุฑูพุช ุจฺฉุงูพ ูุงูโูุง ุฑุง ุจูโุตูุฑุช ุฏุณุช ุงุฌุฑุง ฺฉูุฏ ุชุง ูุฎุฒู Restic ุณุงุฎุชู ุดูุฏ:
        ```bash
        . /etc/backup.env; /path/to/project/backup/scripts/run_files_backup.sh
        ```

5.  **ุงุฌุงุฏ ุงููู Base Backup ุฏุชุงุจุณ:**
    *   ุงุณฺฉุฑูพุช ุจฺฉุงูพ ุฏุชุงุจุณ ุฑุง ูุฒ ุจุฑุง ุงููู ุจุงุฑ ุฏุณุช ุงุฌุฑุง ฺฉูุฏ:
        ```bash
        . /etc/backup.env; /path/to/project/backup/scripts/run_db_backup.sh
        ```

6.  **ุฒูุงูโุจูุฏ Cronjob:**
    *   ูุงู `backup/config/backup.cron` ุฑุง ุจุฑุฑุณ ฺฉุฑุฏู ู ูพุณ ุงุฒ ุงุทููุงู ุงุฒ ุตุญุช ูุณุฑูุง ู ูุชุบุฑูุงุ ุขู ุฑุง ุจู `crontab` ฺฉุงุฑุจุฑ `root` ุงุถุงูู ฺฉูุฏ:
        ```bash
        crontab /path/to/project/backup/config/backup.cron
        ```

---

## ๐ ุจุงุฒุงุจ ุฏุฑ ููุงูุน ุงุถุทุฑุงุฑ

ุจุฑุง ุจุงุฒุงุจ ฺฉุงูู ุณุณุชูุ ุณูุฏ **[๐ Runbook: Disaster Recovery](./docs/RESTORE_RUNBOOK.md)** ุฑุง ุจูโุฏูุช ู ฺฏุงูโุจูโฺฏุงู ุฏูุจุงู ฺฉูุฏ.

## ๐ ูุงูุชูุฑูฺฏ

-   **ูุงฺฏโูุง:** ุฎุฑูุฌ ุงุฌุฑุง ุงุณฺฉุฑูพุชโูุง ุจฺฉุงูพ ุฏุฑ ูุณุฑูุง `/var/log/backup_db.log` ู `/var/log/backup_files.log` ุฐุฎุฑู ูโุดูุฏ. ุงู ูุงูโูุง ุฑุง ุจูโุตูุฑุช ุฏูุฑูโุง ุจุฑุฑุณ ฺฉูุฏ.
-   **ุงุจุฒุงุฑูุง ุฎุงุฑุฌ:** ุจุฑุง ูุงูุชูุฑูฺฏ ุฎูุฏฺฉุงุฑุ ูพุดููุงุฏ ูโุดูุฏ ุงุฒ ุณุฑูุณโูุง ูุงููุฏ [Healthchecks.io](https://healthchecks.io/) ุง [Uptime Kuma](https://github.com/louislam/uptime-kuma) ุงุณุชูุงุฏู ฺฉูุฏ. ุงู ุงุจุฒุงุฑูุง ูโุชูุงููุฏ ุฏุฑ ุตูุฑุช ุนุฏู ุงุฌุฑุง ูููู ฺฉ `cronjob` ุจู ุดูุง ุงุทูุงุนโุฑุณุงู ฺฉููุฏ.

## ๐ ููุงุญุธุงุช ุงููุช

-   **IAM Policy:** ุณุฑูุณ ุงฺฉุงูุช (Service Account) ุงุณุชูุงุฏูโุดุฏู ุจุฑุง ุจฺฉุงูพุ ุจุงุฏ ุฏุงุฑุง ููุด `Storage Object Admin` ุจุงุดุฏ ุชุง ุจุชูุงูุฏ ุจฺฉุงูพโูุง ุฑุง ุจููุณุฏ ู ูุฏุฑุช ฺฉูุฏ. ุฏุณุชุฑุณ ุขู ุฑุง ุจู ููู Bucket ูุญุฏูุฏ ฺฉูุฏ.
-   **Immutable Storage:** ูพุดููุงุฏ ูโุดูุฏ ุงุฒ ูุงุจูุช `Bucket Lock` ุฏุฑ GCS ุจุฑุง ูพุงุฏูโุณุงุฒ WORM (Write-Once, Read-Many) ุงุณุชูุงุฏู ฺฉูุฏ ุชุง ุงุฒ ุญุฐู ุชุตุงุฏู ุง ูุฎุฑุจ ุจฺฉุงูพโูุง ุฌููฺฏุฑ ุดูุฏ.
-   **Encryption:** ูุฑ ุฏู ููุน ุจฺฉุงูพ (ุฏุชุงุจุณ ู ูุงู) ุจูโุตูุฑุช End-to-End ุฑูุฒูฺฏุงุฑ ูโุดููุฏ.
