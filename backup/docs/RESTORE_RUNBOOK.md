# ๐ Runbook: Disaster Recovery

**ุขุฎุฑู ุจูโุฑูุฒุฑุณุงู:** 2025-12-31
**ูุงูฺฉ ุณูุฏ:** ุชู SRE/DevOps

---

## ๐จ ูุฏู ู ุฒูุงู ุงุณุชูุงุฏู

ุงู ุณูุฏ ฺฉ ุฑุงูููุง ฺฏุงูโุจูโฺฏุงู ุจุฑุง ุจุงุฒุงุจ ฺฉุงูู ุณุณุชู ุงุฒ ุจฺฉุงูพโูุง ุฏุฑ ููุงูุน ุงุถุทุฑุงุฑ ุงุณุช. ุงุฒ ุงู Runbook ุฏุฑ ุดุฑุงุท ุฒุฑ ุงุณุชูุงุฏู ฺฉูุฏ:
-   **Data Loss:** ุงุฒ ุฏุณุช ุฑูุชู ุง ุชุฎุฑุจ ุฏุงุฏูโูุง ุฏุชุงุจุณ (ูุซูุงู ุญุฐู ุชุตุงุฏู ุฌุฏุงูู).
-   **Server Failure:** ุงุฒ ฺฉุงุฑ ุงูุชุงุฏู ฺฉุงูู ุณุฑูุฑ ุงุตู ุฏุชุงุจุณ ุง ูุงูโูุง.
-   **Ransomware Attack:** ุขููุฏู ุดุฏู ุณุฑูุฑูุง ู ูุงุฒ ุจู ุจุงุฒฺฏุฑุฏุงู ุจู ฺฉ ูุถุนุช ุณุงูู.

**โ๏ธ ููู:** ูุจู ุงุฒ ุดุฑูุนุ ูุถุนุช ุฑุง ุงุฑุฒุงุจ ฺฉุฑุฏู ู ุจุง ูุฏุฑ ูู ููุงููฺฏ ฺฉูุฏ. ุงู ูุฑุขูุฏ ุจุงุนุซ Downtime ุฎูุงูุฏ ุดุฏ.

---

## ๐ ูพุดโูุงุฒูุง

ูุจู ุงุฒ ุดุฑูุน ูุฑุขูุฏ ุจุงุฒุงุจุ ุงุทููุงู ุญุงุตู ฺฉูุฏ ฺฉู ููุงุฑุฏ ุฒุฑ ุฑุง ุฏุฑ ุงุฎุชุงุฑ ุฏุงุฑุฏ:

1.  **ูุญุท ุจุงุฒุงุจ (Recovery Environment):**
    *   ฺฉ ุณุฑูุฑ ุง VM ุฌุฏุฏ ู ุงุฒููู ุจุง ุณุณุชูโุนุงูู ูุดุงุจู ุณุฑูุฑ Production.
    *   ุฏุณุชุฑุณ `root` ุง `sudo` ุจู ุงู ุณุฑูุฑ.

2.  **ุงุจุฒุงุฑูุง ููุฑุฏ ูุงุฒ ูุตุจ ุดุฏู:**
    *   `postgresql-client`
    *   `wal-g`
    *   `restic`
    *   `jq`

3.  **ุฏุณุชุฑุณ ุจู Secretูุง:**
    *   ูุงู JSON ฺฉูุฏ Service Account ฺฏูฺฏู (`GOOGLE_APPLICATION_CREDENTIALS`).
    *   ุดูุงุณู ูพุฑูฺู ฺฏูฺฏู (`GOOGLE_PROJECT_ID`).
    *   ุฑูุฒ ุนุจูุฑ ูุฎุฒู Restic (`RESTIC_PASSWORD`).
    *   ฺฉูุฏ GPG ุจุฑุง ุฑูุฒฺฏุดุง ุจฺฉุงูพโูุง `wal-g` (ุฏุฑ ุตูุฑุช ุงุณุชูุงุฏู).
    *   ุงู ุงุทูุงุนุงุช ุจุงุฏ ุฏุฑ ฺฉ Vault ุง ูุฏุฑ ุฑูุฒ ุงูู ูฺฏูโุฏุงุฑ ุดููุฏ.

---

## โ๏ธ ฺฏุงู ฑ: ุขูุงุฏูโุณุงุฒ ูุญุท ุจุงุฒุงุจ

1.  **ูุตุจ ุงุจุฒุงุฑูุง:**
    ```bash
    sudo apt-get update
    sudo apt-get install -y postgresql-client python3-pip jq
    # Install wal-g and restic (example using pip and direct download)
    sudo pip3 install wal-g
    wget https://github.com/restic/restic/releases/download/v0.16.0/restic_0.16.0_linux_amd64.bz2
    bzip2 -d restic_0.16.0_linux_amd64.bz2
    sudo mv restic_0.16.0_linux_amd64 /usr/local/bin/restic
    sudo chmod +x /usr/local/bin/restic
    ```

2.  **ุชูุธู ูุชุบุฑูุง ูุญุท:**
    *   ูุงู Service Account ุฎูุฏ ุฑุง ุจู ุณุฑูุฑ ุฌุฏุฏ ููุชูู ฺฉูุฏ (ูุซูุงู ุฏุฑ ูุณุฑ `~/gcs_service_account.json`).
    *   ุชูุงู Secretูุง ููุฑุฏ ูุงุฒ ุฑุง ุฏุฑ ฺฉ ูุงู ูููุช (ูุซูุงู `~/restore.env`) ูุฑุงุฑ ุฏูุฏ ู ุฏุณุชุฑุณ ุขู ุฑุง ูุญุฏูุฏ ฺฉูุฏ.
    ```bash
    # ~/restore.env
    export GOOGLE_APPLICATION_CREDENTIALS="~/gcs_service_account.json"
    export GOOGLE_PROJECT_ID="your-gcp-project-id"
    export RESTIC_REPOSITORY="gcs:your-gcs-bucket-name/media"
    export RESTIC_PASSWORD="your_strong_restic_encryption_password"
    ```
    *   ุงู ูุชุบุฑูุง ุฑุง ุฏุฑ session ูุนู ุฎูุฏ `source` ฺฉูุฏ:
    ```bash
    source ~/restore.env
    chmod 400 ~/restore.env
    ```

---

## ๐ ฺฏุงู ฒ: ุจุงุฒุงุจ ุฏุชุงุจุณ (PostgreSQL)

ุงู ูุฑุขูุฏ ุฏุชุงุจุณ ุฑุง ุจู ุขุฎุฑู ููุทู ููฺฉู ุฏุฑ ุฒูุงู (Point-in-Time-Recovery) ุจุงุฒูโฺฏุฑุฏุงูุฏ.

1.  **ูุชููู ฺฉุฑุฏู ุณุฑูุณ PostgreSQL (ุงฺฏุฑ ุฏุฑ ุญุงู ุงุฌุฑุงุณุช):**
    ```bash
    sudo systemctl stop postgresql
    ```

2.  **ูพุงฺฉ ฺฉุฑุฏู ุฏุงุฑฺฉุชูุฑ ุฏุชุง (ุฎุทุฑูุงฺฉ! ููุท ุฑู ุณุฑูุฑ ุฌุฏุฏ):**
    *   ุฏุงุฑฺฉุชูุฑ ุฏุชุง PostgreSQL ุฑุง ุฎุงู ฺฉูุฏ ุชุง ุจฺฉุงูพ ุฏุฑ ุขู ุจุงุฒูุดุงู ุดูุฏ.
    ```bash
    sudo rm -rf /var/lib/postgresql/14/main/*
    ```

3.  **ุจุงุฑฺฏุฐุงุฑ ฺฉุงููฺฏ WAL-G:**
    *   ูุงู `backup/config/walg_config.json` ุฑุง ุงุฒ ูุฎุฒู Git ุง ูุญู ุงูู ุฎูุฏ ุจู ุณุฑูุฑ ุฌุฏุฏ ููุชูู ฺฉุฑุฏู ู ูุณุฑ `GOOGLE_APPLICATION_CREDENTIALS` ุฑุง ุฏุฑ ุขู ูุชูุงุณุจ ุจุง ุณุฑูุฑ ุฌุฏุฏ ูุฑุงุด ฺฉูุฏ. ุณูพุณ ูุงู ุฑุง ุฏุฑ ูุณุฑ `~/.walg.json` ูุฑุงุฑ ุฏูุฏ.

4.  **ุฏุฑุงูุช ุขุฎุฑู Base Backup:**
    *   ุฏุณุชูุฑ ุฒุฑ ุขุฎุฑู ุจฺฉุงูพ ฺฉุงูู ุฑุง ูพุฏุง ฺฉุฑุฏู ู ุฏุฑ ุฏุงุฑฺฉุชูุฑ ุฏุชุง PostgreSQL ุงุณุชุฎุฑุงุฌ ูโฺฉูุฏ.
    ```bash
    sudo -u postgres wal-g backup-fetch /var/lib/postgresql/14/main LATEST
    ```

5.  **ุงุฌุงุฏ ูุงู ุณฺฏูุงู ุจุงุฒุงุจ:**
    *   ุฏุฑ PostgreSQL ูุณุฎูโูุง ุฌุฏุฏุ ุจูโุฌุง `recovery.conf`ุ ุชูุธูุงุช ุฏุฑ `postgresql.conf` ุงูุฌุงู ุดุฏู ู ฺฉ ูุงู ุฎุงู ุจู ูุงู `recovery.signal` ุงุฌุงุฏ ูโุดูุฏ.
    ```bash
    sudo -u postgres touch /var/lib/postgresql/14/main/recovery.signal
    ```
    *   ุณูพุณ ูุงู `postgresql.conf` ุฑุง ูุฑุงุด ฺฉุฑุฏู ู ุฏุณุชูุฑ ุจุงุฒุงุจ ุฑุง ุงุถุงูู ฺฉูุฏ:
    ```ini
    # /etc/postgresql/14/main/postgresql.conf
    restore_command = 'wal-g wal-fetch %f %p'
    ```

6.  **ุดุฑูุน ุจู ฺฉุงุฑ PostgreSQL ู ูุงูุชูุฑูฺฏ ูุงฺฏโูุง:**
    *   ุณุฑูุณ PostgreSQL ุฑุง ุงุณุชุงุฑุช ุจุฒูุฏ. ุฏุฑ ุงู ูุฑุญููุ PostgreSQL ูุงุฑุฏ ุญุงูุช Recovery Mode ุดุฏู ู ุดุฑูุน ุจู ุฏุฑุงูุช ู ุงุนูุงู ูุงูโูุง WAL ุงุฒ S3 ูโฺฉูุฏ.
    ```bash
    sudo systemctl start postgresql
    ```
    *   ูุงฺฏโูุง PostgreSQL ุฑุง ุจุฑุง ูุดุงูุฏู ูุฑุขูุฏ ุฏูุจุงู ฺฉูุฏ:
    ```bash
    sudo tail -f /var/log/postgresql/postgresql-14-main.log
    ```
    *   ููุชุธุฑ ุจูุงูุฏ ุชุง ูพุบุงู `database system is ready to accept connections` ุฑุง ุจุจูุฏ. ุงู ุจู ูุนู ุงุชูุงู ูุฑุขูุฏ ุจุงุฒุงุจ ุงุณุช.

7.  **ููุง ฺฉุฑุฏู ุจุงุฒุงุจ:**
    *   ูพุณ ุงุฒ ุงุชูุงูุ PostgreSQL ุจูโุตูุฑุช ุฎูุฏฺฉุงุฑ ูุงู `recovery.signal` ุฑุง ุชุบุฑ ูุงู ุฏุงุฏู ู ุงุฒ ุญุงูุช Recovery ุฎุงุฑุฌ ูโุดูุฏ. ุจุง ฺฉ `psql` ุณุงุฏู ุงุฒ ุตุญุช ุนููฺฉุฑุฏ ุฏุชุงุจุณ ูุทูุฆู ุดูุฏ.

---

## ๐ผ ฺฏุงู ณ: ุจุงุฒุงุจ ูุงูโูุง ู Media

1.  **ุจุฑุฑุณ ุงุชุตุงู ุจู ูุฎุฒู Restic:**
    ```bash
    restic snapshots
    ```
    ุงู ุฏุณุชูุฑ ุจุงุฏ ูุณุช ุงุฒ ุจฺฉุงูพโูุง ููุฌูุฏ ุฑุง ููุงุด ุฏูุฏ.

2.  **ุจุงุฒฺฏุฑุฏุงู ุขุฎุฑู ุจฺฉุงูพ:**
    *   ฺฉ ุฏุงุฑฺฉุชูุฑ ููุตุฏ ุจุฑุง ูุงูโูุง ุจุงุฒุงุจโุดุฏู ุงุฌุงุฏ ฺฉูุฏ.
    ```bash
    sudo mkdir -p /var/www/media_restored
    ```
    *   ุฏุณุชูุฑ ุฒุฑ ุขุฎุฑู ุจฺฉุงูพ ุฑุง ุฏุฑ ุงู ุฏุงุฑฺฉุชูุฑ ุจุงุฒฺฏุฑุฏุงู ูโฺฉูุฏ:
    ```bash
    sudo restic restore latest --target /var/www/media_restored
    ```

3.  **ุฌุงฺฏุฒู ูุงูโูุง:**
    *   ูพุณ ุงุฒ ุชุฃุฏ ุตุญุช ูุงูโูุง ุจุงุฒุงุจโุดุฏูุ ุฏุงุฑฺฉุชูุฑ ูุฏู ุฑุง ุฌุงุจุฌุง ฺฉุฑุฏู ู ุฏุงุฑฺฉุชูุฑ ุฌุฏุฏ ุฑุง ุฌุงฺฏุฒู ุขู ฺฉูุฏ.
    ```bash
    sudo mv /var/www/media /var/www/media_old
    sudo mv /var/www/media_restored /var/www/media
    sudo chown -R www-data:www-data /var/www/media
    ```

---

## โ ฺฏุงู ด: ุงุนุชุจุงุฑุณูุฌ ูพุณ ุงุฒ ุจุงุฒุงุจ

ฺฉ ฺฺฉโูุณุช ุจุฑุง ุงุทููุงู ุงุฒ ุณูุงูุช ฺฉุงูู ุณุณุชู:
-   [ ] ุงูพูฺฉุดู ุจุง ููููุช ุจู ุฏุชุงุจุณ ูุชุตู ูโุดูุฏ.
-   [ ] ูโุชูุงู ุจู ุณุงุช ูุงฺฏู ฺฉุฑุฏ.
-   [ ] ุขุฎุฑู ุณูุงุฑุด ุซุจุชโุดุฏู ูุจู ุงุฒ ูููุน ูุงุฌุนู ุฏุฑ ุณุณุชู ูุงุจู ูุดุงูุฏู ุงุณุช.
-   [ ] ุชุตุงูุฑ ูุญุตููุงุช ุจูโุฏุฑุณุช ููุงุด ุฏุงุฏู ูโุดููุฏ.
-   [ ] ฺฉ ุชุฑุงฺฉูุด ุขุฒูุงุด (ุซุจุช ุณูุงุฑุด) ุจุง ููููุช ุงูุฌุงู ูโุดูุฏ.

---

## ๐ ุชูุงุณโูุง ุงุถุทุฑุงุฑ

| ููุด | ูุงู | ุดูุงุฑู ุชูุงุณ |
| --- | --- | --- |
| ูุฏุฑ ูู | ... | ... |
| ูุณุฆูู ุฒุฑุณุงุฎุช | ... | ... |
| ุจุฑูุงููโููุณ ุงุฑุดุฏ | ... | ... |
