# نقشه راه افزایش پوشش تست پروژه

این سند به عنوان نقشه راه برای نوشتن تست‌های واحد (Unit) و یکپارچه‌سازی (Integration) برای پروژه عمل می‌کند. هدف اصلی، رسیدن به پوشش تست قابل قبول (حداقل ۸۵٪) برای منطق تجاری اصلی پروژه و اطمینان از پایداری و صحت عملکرد سیستم است.

## فاز ۱: پیکربندی اولیه و ساختار تست

قبل از شروع به نوشتن تست برای هر اپلیکیشن، باید ساختار لازم ایجاد شود.

1.  **ایجاد پوشه‌های تست**: در هر اپلیکیشن (`shop`, `orders`, `cart`, `payment`, `account`, `discounts`, `coupons`, `shipping`, `sms`)، یک پوشه به نام `tests/` ایجاد کنید.
2.  **ایجاد فایل `__init__.py`**: در هر پوشه‌ی `tests/`، یک فایل خالی `__init__.py` بسازید تا پایتون آن را به عنوان یک پکیج بشناسد.
3.  **استفاده از Factory-Boy**: برای تولید داده‌های تستی تمیز و قابل استفاده مجدد، از `factory-boy` استفاده کنید. برای هر اپلیکیشن، یک فایل `factories.py` برای تعریف فکتوری‌های مدل‌های آن ایجاد کنید.

## فاز ۲: نوشتن تست برای منطق تجاری اصلی (اولویت بالا)

### اپلیکیشن `shop`

-   [ ] **تست مدل‌ها (`tests/test_models.py`)**:
    -   [ ] تست ساخت صحیح مدل‌های `Product`, `Category`, `Review`.
    -   [ ] تست اعتبارسنجی فیلدها (مانند `validators` در فیلد `thumbnail`).
    -   [ ] تست متدهای سفارشی مدل‌ها (در صورت وجود).
    -   [ ] تست سیگنال `update_product_rating` که پس از ذخیره یا حذف `Review` فراخوانی می‌شود.
-   [ ] **تست سرویس‌ها (`tests/test_services.py`)**:
    -   [ ] نوشتن تست‌های واحد برای تمام توابع و کلاس‌های موجود در `services.py`.
-   [ ] **تست API ها (`tests/test_views.py`)**:
    -   [ ] تست `ProductViewSet` برای عملیات `list`, `retrieve`, `create`, `update`, `delete`.
    -   [ ] تست سطوح دسترسی (Permissions) برای اطمینان از اینکه فقط کاربران مجاز می‌توانند محصولات را ویرایش کنند.
    -   [ ] تست فیلتر کردن و جستجوی محصولات.

### اپلیکیشن `orders`

-   [ ] **تست مدل‌ها (`tests/test_models.py`)**:
    -   [ ] تست ساخت صحیح `Order` و `OrderItem`.
    -   [ ] تست ماشین وضعیت (State Machine) مدل `Order` و اطمینان از صحت تغییر وضعیت‌ها (e.g., from 'pending' to 'paid').
-   [ ] **تست سرویس‌ها (`tests/test_services.py`)**:
    -   [ ] تست کامل سرویس `create_order`، به خصوص منطق مربوط به قفل کردن رکوردها (`select_for_update`) برای جلوگیری از `race condition`.
    -   [ ] تست منطق مربوط به بازگرداندن موجودی محصول پس از کنسل شدن سفارش.
-   [ ] **تست سریالایزرها (`tests/test_serializers.py`)**:
    -   [ ] تست اعتبارسنجی `OrderCreateSerializer` و اطمینان از اینکه سفارش با موجودی ناکافی ثبت نمی‌شود.
-   [ ] **تست API ها (`tests/test_views.py`)**:
    -   [ ] تست `OrderViewSet` و بررسی دسترسی کاربران مختلف (کاربر عادی فقط به سفارشات خودش دسترسی دارد).

### اپلیکیشن `payment`

-   [ ] **تست سرویس‌ها (`tests/test_services.py`)**:
    -   [ ] تست سرویس `process_payment` و `verify_payment`.
    -   [ ] تست ایده‌پردازی (Idempotency) در فرآیند تایید پرداخت.
-   [ ] **تست درگاه‌های پرداخت (`tests/test_gateways.py`)**:
    -   [ ] Mock کردن درخواست‌های `HTTP` به سرویس خارجی (Zibal) و تست رفتار `ZibalGateway` در سناریوهای موفق و ناموفق.
-   [ ] **تست API ها (`tests/test_views.py`)**:
    -   [ ] تست view های مربوط به شروع و تایید پرداخت.

## فاز ۳: نوشتن تست برای سایر ماژول‌ها (اولویت متوسط)

### اپلیکیشن `cart`

-   [ ] **تست سرویس‌ها (`tests/test_services.py`)**:
    -   [ ] تست منطق اضافه کردن، حذف کردن، و مشاهده آیتم‌های سبد خرید برای کاربران لاگین کرده و مهمان.
-   [ ] **تست API ها (`tests/test_views.py`)**:
    -   [ ] تست کامل `CartViewSet`.

### اپلیکیشن‌های `discounts` & `coupons`

-   [ ] **تست سرویس‌ها**:
    -   [ ] تست منطق بررسی و اعمال تخفیف‌ها و کوپن‌ها بر روی سفارش.

### اپلیکیشن `account`

-   [ ] **تست API ها**:
    -   [ ] تست فرآیندهای ثبت‌نام، ورود، خروج و مشاهده پروفایل با استفاده از `djoser`.

## فاز ۴: تست یکپارچه‌سازی‌های خارجی (اولویت پایین)

-   [ ] **اپلیکیشن `shipping`**:
    -   [ ] Mock کردن API سرویس Postex و تست سرویس‌های مربوط به حمل‌ونقل.
-   [ ] **اپلیکیشن `sms`**:
    -   [ ] Mock کردن API سرویس SMS.ir و تست سرویس ارسال پیامک.

## نحوه اجرای تست‌ها و مشاهده گزارش پوشش

برای اجرای تمام تست‌ها و دریافت گزارش پوشش، از دستور زیر در ریشه پروژه استفاده کنید:

```bash
pytest --cov=.
```

این دستور تست‌ها را اجرا کرده و گزارشی از خطوط کدی که توسط تست‌ها پوشش داده نشده‌اند، در ترمینال نمایش می‌دهد.
